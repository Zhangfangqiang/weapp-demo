export function registerGLTFLoader(B){B.GLTFLoader=function(){function e(e){this.manager=e!==undefined?e:B.DefaultLoadingManager;this.dracoLoader=null;this.ddsLoader=null}e.prototype={constructor:e,crossOrigin:"anonymous",load:function(r,a,e,t){var n=this;var i;if(this.resourcePath!==undefined){i=this.resourcePath}else if(this.path!==undefined){i=this.path}else{i=B.LoaderUtils.extractUrlBase(r)}n.manager.itemStart(r);var s=function(e){if(t){t(e)}else{console.error(e)}n.manager.itemError(r);n.manager.itemEnd(r)};var o=new B.FileLoader(n.manager);o.setPath(this.path);o.setResponseType("arraybuffer");if(n.crossOrigin==="use-credentials"){o.setWithCredentials(true)}o.load(r,function(e){try{n.parse(e,i,function(e){a(e);n.manager.itemEnd(r)},s)}catch(e){s(e)}},e,s)},setCrossOrigin:function(e){this.crossOrigin=e;return this},setPath:function(e){this.path=e;return this},setResourcePath:function(e){this.resourcePath=e;return this},setDRACOLoader:function(e){this.dracoLoader=e;return this},setDDSLoader:function(e){this.ddsLoader=e;return this},parse:function(e,r,a,t){var n;var i={};if(typeof e==="string"){n=e}else{var s=B.LoaderUtils.decodeText(new Uint8Array(e,0,4));if(s===m){try{i[h.KHR_BINARY_GLTF]=new g(e)}catch(e){if(t)t(e);return}n=i[h.KHR_BINARY_GLTF].content}else{n=B.LoaderUtils.decodeText(new Uint8Array(e))}}var o=JSON.parse(n);if(o.asset===undefined||o.asset.version[0]<2){if(t)t(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead."));return}if(o.extensionsUsed){for(var u=0;u<o.extensionsUsed.length;++u){var l=o.extensionsUsed[u];var f=o.extensionsRequired||[];switch(l){case h.KHR_LIGHTS_PUNCTUAL:i[l]=new d(o);break;case h.KHR_MATERIALS_UNLIT:i[l]=new v;break;case h.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:i[l]=new S;break;case h.KHR_DRACO_MESH_COMPRESSION:i[l]=new T(o,this.dracoLoader);break;case h.MSFT_TEXTURE_DDS:i[h.MSFT_TEXTURE_DDS]=new c(this.ddsLoader);break;case h.KHR_TEXTURE_TRANSFORM:i[h.KHR_TEXTURE_TRANSFORM]=new M;break;default:if(f.indexOf(l)>=0){console.warn('THREE.GLTFLoader: Unknown extension "'+l+'".')}}}}var p=new D(o,i,{path:r||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager});p.parse(a,t)}};function t(){var a={};return{get:function(e){return a[e]},add:function(e,r){a[e]=r},remove:function(e){delete a[e]},removeAll:function(){a={}}}}var h={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function c(e){if(!e){throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing THREE.DDSLoader")}this.name=h.MSFT_TEXTURE_DDS;this.ddsLoader=e}function d(e){this.name=h.KHR_LIGHTS_PUNCTUAL;var r=e.extensions&&e.extensions[h.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=r.lights||[]}d.prototype.loadLight=function(e){var r=this.lightDefs[e];var a;var t=new B.Color(16777215);if(r.color!==undefined)t.fromArray(r.color);var n=r.range!==undefined?r.range:0;switch(r.type){case"directional":a=new B.DirectionalLight(t);a.target.position.set(0,0,-1);a.add(a.target);break;case"point":a=new B.PointLight(t);a.distance=n;break;case"spot":a=new B.SpotLight(t);a.distance=n;r.spot=r.spot||{};r.spot.innerConeAngle=r.spot.innerConeAngle!==undefined?r.spot.innerConeAngle:0;r.spot.outerConeAngle=r.spot.outerConeAngle!==undefined?r.spot.outerConeAngle:Math.PI/4;a.angle=r.spot.outerConeAngle;a.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle;a.target.position.set(0,0,-1);a.add(a.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+r.type+'".')}a.position.set(0,0,0);a.decay=2;if(r.intensity!==undefined)a.intensity=r.intensity;a.name=r.name||"light_"+e;return Promise.resolve(a)};function v(){this.name=h.KHR_MATERIALS_UNLIT}v.prototype.getMaterialType=function(){return B.MeshBasicMaterial};v.prototype.extendParams=function(e,r,a){var t=[];e.color=new B.Color(1,1,1);e.opacity=1;var n=r.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){var i=n.baseColorFactor;e.color.fromArray(i);e.opacity=i[3]}if(n.baseColorTexture!==undefined){t.push(a.assignTexture(e,"map",n.baseColorTexture))}}return Promise.all(t)};var m="glTF";var u=12;var l={JSON:1313821514,BIN:5130562};function g(e){this.name=h.KHR_BINARY_GLTF;this.content=null;this.body=null;var r=new DataView(e,0,u);this.header={magic:B.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:r.getUint32(4,true),length:r.getUint32(8,true)};if(this.header.magic!==m){throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.")}else if(this.header.version<2){throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.")}var a=new DataView(e,u);var t=0;while(t<a.byteLength){var n=a.getUint32(t,true);t+=4;var i=a.getUint32(t,true);t+=4;if(i===l.JSON){var s=new Uint8Array(e,u+t,n);this.content=B.LoaderUtils.decodeText(s)}else if(i===l.BIN){var o=u+t;this.body=e.slice(o,o+n)}t+=n}if(this.content===null){throw new Error("THREE.GLTFLoader: JSON content not found.")}}function T(e,r){if(!r){throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.")}this.name=h.KHR_DRACO_MESH_COMPRESSION;this.json=e;this.dracoLoader=r}T.prototype.decodePrimitive=function(e,r){var a=this.json;var t=this.dracoLoader;var n=e.extensions[this.name].bufferView;var i=e.extensions[this.name].attributes;var s={};var o={};var u={};for(var l in i){var f=E[l]||l.toLowerCase();s[f]=i[l]}for(l in e.attributes){var f=E[l]||l.toLowerCase();if(i[l]!==undefined){var p=a.accessors[e.attributes[l]];var c=_[p.componentType];u[f]=c;o[f]=p.normalized===true}}return r.getDependency("bufferView",n).then(function(e){return new Promise(function(n){t.decodeDracoFile(e,function(e){for(var r in e.attributes){var a=e.attributes[r];var t=o[r];if(t!==undefined)a.normalized=t}n(e)},s,u)})})};function M(){this.name=h.KHR_TEXTURE_TRANSFORM}M.prototype.extendTexture=function(e,r){e=e.clone();if(r.offset!==undefined){e.offset.fromArray(r.offset)}if(r.rotation!==undefined){e.rotation=r.rotation}if(r.scale!==undefined){e.repeat.fromArray(r.scale)}if(r.texCoord!==undefined){console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.')}e.needsUpdate=true;return e};function S(){return{name:h.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return B.ShaderMaterial},extendParams:function(e,r,a){var t=r.extensions[this.name];var n=B.ShaderLib["standard"];var i=B.UniformsUtils.clone(n.uniforms);var s=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n");var o=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n");var u=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n");var l=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n");var f=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n");var p=n.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",o).replace("#include <roughnessmap_fragment>",u).replace("#include <metalnessmap_fragment>",l).replace("#include <lights_physical_fragment>",f);delete i.roughness;delete i.metalness;delete i.roughnessMap;delete i.metalnessMap;i.specular={value:(new B.Color).setHex(1118481)};i.glossiness={value:.5};i.specularMap={value:null};i.glossinessMap={value:null};e.vertexShader=n.vertexShader;e.fragmentShader=p;e.uniforms=i;e.defines={STANDARD:""};e.color=new B.Color(1,1,1);e.opacity=1;var c=[];if(Array.isArray(t.diffuseFactor)){var d=t.diffuseFactor;e.color.fromArray(d);e.opacity=d[3]}if(t.diffuseTexture!==undefined){c.push(a.assignTexture(e,"map",t.diffuseTexture))}e.emissive=new B.Color(0,0,0);e.glossiness=t.glossinessFactor!==undefined?t.glossinessFactor:1;e.specular=new B.Color(1,1,1);if(Array.isArray(t.specularFactor)){e.specular.fromArray(t.specularFactor)}if(t.specularGlossinessTexture!==undefined){var h=t.specularGlossinessTexture;c.push(a.assignTexture(e,"glossinessMap",h));c.push(a.assignTexture(e,"specularMap",h))}return Promise.all(c)},createMaterial:function(e){var r=new B.ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:true,lights:true,opacity:e.opacity,transparent:e.transparent});r.isGLTFSpecularGlossinessMaterial=true;r.color=e.color;r.map=e.map===undefined?null:e.map;r.lightMap=null;r.lightMapIntensity=1;r.aoMap=e.aoMap===undefined?null:e.aoMap;r.aoMapIntensity=1;r.emissive=e.emissive;r.emissiveIntensity=1;r.emissiveMap=e.emissiveMap===undefined?null:e.emissiveMap;r.bumpMap=e.bumpMap===undefined?null:e.bumpMap;r.bumpScale=1;r.normalMap=e.normalMap===undefined?null:e.normalMap;if(e.normalScale)r.normalScale=e.normalScale;r.displacementMap=null;r.displacementScale=1;r.displacementBias=0;r.specularMap=e.specularMap===undefined?null:e.specularMap;r.specular=e.specular;r.glossinessMap=e.glossinessMap===undefined?null:e.glossinessMap;r.glossiness=e.glossiness;r.alphaMap=null;r.envMap=e.envMap===undefined?null:e.envMap;r.envMapIntensity=1;r.refractionRatio=.98;r.extensions.derivatives=true;return r},cloneMaterial:function(e){var r=e.clone();r.isGLTFSpecularGlossinessMaterial=true;var a=this.specularGlossinessParams;for(var t=0,n=a.length;t<n;t++){var i=e[a[t]];r[a[t]]=i&&i.isColor?i.clone():i}return r},refreshUniforms:function(e,r,a,t,n){if(n.isGLTFSpecularGlossinessMaterial!==true){return}var i=n.uniforms;var s=n.defines;i.opacity.value=n.opacity;i.diffuse.value.copy(n.color);i.emissive.value.copy(n.emissive).multiplyScalar(n.emissiveIntensity);i.map.value=n.map;i.specularMap.value=n.specularMap;i.alphaMap.value=n.alphaMap;i.lightMap.value=n.lightMap;i.lightMapIntensity.value=n.lightMapIntensity;i.aoMap.value=n.aoMap;i.aoMapIntensity.value=n.aoMapIntensity;var o;if(n.map){o=n.map}else if(n.specularMap){o=n.specularMap}else if(n.displacementMap){o=n.displacementMap}else if(n.normalMap){o=n.normalMap}else if(n.bumpMap){o=n.bumpMap}else if(n.glossinessMap){o=n.glossinessMap}else if(n.alphaMap){o=n.alphaMap}else if(n.emissiveMap){o=n.emissiveMap}if(o!==undefined){if(o.isWebGLRenderTarget){o=o.texture}if(o.matrixAutoUpdate===true){o.updateMatrix()}i.uvTransform.value.copy(o.matrix)}if(n.envMap){i.envMap.value=n.envMap;i.envMapIntensity.value=n.envMapIntensity;i.flipEnvMap.value=n.envMap.isCubeTexture?-1:1;i.reflectivity.value=n.reflectivity;i.refractionRatio.value=n.refractionRatio;i.maxMipLevel.value=e.properties.get(n.envMap).__maxMipLevel}i.specular.value.copy(n.specular);i.glossiness.value=n.glossiness;i.glossinessMap.value=n.glossinessMap;i.emissiveMap.value=n.emissiveMap;i.bumpMap.value=n.bumpMap;i.normalMap.value=n.normalMap;i.displacementMap.value=n.displacementMap;i.displacementScale.value=n.displacementScale;i.displacementBias.value=n.displacementBias;if(i.glossinessMap.value!==null&&s.USE_GLOSSINESSMAP===undefined){s.USE_GLOSSINESSMAP="";s.USE_ROUGHNESSMAP=""}if(i.glossinessMap.value===null&&s.USE_GLOSSINESSMAP!==undefined){delete s.USE_GLOSSINESSMAP;delete s.USE_ROUGHNESSMAP}}}}function w(e,r,a,t){B.Interpolant.call(this,e,r,a,t)}w.prototype=Object.create(B.Interpolant.prototype);w.prototype.constructor=w;w.prototype.copySampleValue_=function(e){var r=this.resultBuffer,a=this.sampleValues,t=this.valueSize,n=e*t*3+t;for(var i=0;i!==t;i++){r[i]=a[n+i]}return r};w.prototype.beforeStart_=w.prototype.copySampleValue_;w.prototype.afterEnd_=w.prototype.copySampleValue_;w.prototype.interpolate_=function(e,r,a,t){var n=this.resultBuffer;var i=this.sampleValues;var s=this.valueSize;var o=s*2;var u=s*3;var l=t-r;var f=(a-r)/l;var p=f*f;var c=p*f;var d=e*u;var h=d-u;var v=-2*c+3*p;var m=c-p;var g=1-v;var T=m-p+f;for(var M=0;M!==s;M++){var S=i[h+M+s];var L=i[h+M+o]*l;var y=i[d+M+s];var R=i[d+M]*l;n[M]=g*S+T*L+v*y+m*R}return n};var L={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};var _={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var y={9728:B.NearestFilter,9729:B.LinearFilter,9984:B.NearestMipmapNearestFilter,9985:B.LinearMipmapNearestFilter,9986:B.NearestMipmapLinearFilter,9987:B.LinearMipmapLinearFilter};var R={33071:B.ClampToEdgeWrapping,33648:B.MirroredRepeatWrapping,10497:B.RepeatWrapping};var x={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};var E={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"};var b={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"};var I={CUBICSPLINE:undefined,LINEAR:B.InterpolateLinear,STEP:B.InterpolateDiscrete};var A={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};var P={"image/png":B.RGBAFormat,"image/jpeg":B.RGBFormat};function F(e,r){if(typeof e!=="string"||e==="")return"";if(/^https?:\/\//i.test(r)&&/^\//.test(e)){r=r.replace(/(^https?:\/\/[^\/]+).*/i,"$1")}if(/^(https?:)?\/\//i.test(e))return e;if(/^data:.*,.*$/i.test(e))return e;if(/^blob:.*$/i.test(e))return e;return r+e}var r;function i(){r=r||new B.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:false,depthTest:true,side:B.FrontSide});return r}function N(e,r,a){for(var t in a.extensions){if(e[t]===undefined){r.userData.gltfExtensions=r.userData.gltfExtensions||{};r.userData.gltfExtensions[t]=a.extensions[t]}}}function U(e,r){if(r.extras!==undefined){if(typeof r.extras==="object"){Object.assign(e.userData,r.extras)}else{console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+r.extras)}}}function f(d,h,e){var v=false;var m=false;for(var r=0,a=h.length;r<a;r++){var t=h[r];if(t.POSITION!==undefined)v=true;if(t.NORMAL!==undefined)m=true;if(v&&m)break}if(!v&&!m)return Promise.resolve(d);var n=[];var i=[];for(var r=0,a=h.length;r<a;r++){var t=h[r];if(v){var s=t.POSITION!==undefined?e.getDependency("accessor",t.POSITION):d.attributes.position;n.push(s)}if(m){var s=t.NORMAL!==undefined?e.getDependency("accessor",t.NORMAL):d.attributes.normal;i.push(s)}}return Promise.all([Promise.all(n),Promise.all(i)]).then(function(e){var r=e[0];var a=e[1];for(var t=0,n=r.length;t<n;t++){if(d.attributes.position===r[t])continue;r[t]=C(r[t])}for(var t=0,n=a.length;t<n;t++){if(d.attributes.normal===a[t])continue;a[t]=C(a[t])}for(var t=0,n=h.length;t<n;t++){var i=h[t];var s="morphTarget"+t;if(v){if(i.POSITION!==undefined){var o=r[t];o.name=s;var u=d.attributes.position;for(var l=0,f=o.count;l<f;l++){o.setXYZ(l,o.getX(l)+u.getX(l),o.getY(l)+u.getY(l),o.getZ(l)+u.getZ(l))}}}if(m){if(i.NORMAL!==undefined){var p=a[t];p.name=s;var c=d.attributes.normal;for(var l=0,f=p.count;l<f;l++){p.setXYZ(l,p.getX(l)+c.getX(l),p.getY(l)+c.getY(l),p.getZ(l)+c.getZ(l))}}}}if(v)d.morphAttributes.position=r;if(m)d.morphAttributes.normal=a;return d})}function O(e,r){e.updateMorphTargets();if(r.weights!==undefined){for(var a=0,t=r.weights.length;a<t;a++){e.morphTargetInfluences[a]=r.weights[a]}}if(r.extras&&Array.isArray(r.extras.targetNames)){var n=r.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(var a=0,t=n.length;a<t;a++){e.morphTargetDictionary[n[a]]=a}}else{console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}}function G(e){var r=e.extensions&&e.extensions[h.KHR_DRACO_MESH_COMPRESSION];var a;if(r){a="draco:"+r.bufferView+":"+r.indices+":"+n(r.attributes)}else{a=e.indices+":"+n(e.attributes)+":"+e.mode}return a}function n(e){var r="";var a=Object.keys(e).sort();for(var t=0,n=a.length;t<n;t++){r+=a[t]+":"+e[a[t]]+";"}return r}function C(e){if(e.isInterleavedBufferAttribute){var r=e.count;var a=e.itemSize;var t=e.array.slice(0,r*a);for(var n=0,i=0;n<r;++n){t[i++]=e.getX(n);if(a>=2)t[i++]=e.getY(n);if(a>=3)t[i++]=e.getZ(n);if(a>=4)t[i++]=e.getW(n)}return new B.BufferAttribute(t,a,e.normalized)}return e.clone()}function D(e,r,a){this.json=e||{};this.extensions=r||{};this.options=a||{};this.cache=new t;this.primitiveCache={};this.textureLoader=new B.TextureLoader(this.options.manager);this.textureLoader.setCrossOrigin(this.options.crossOrigin);this.fileLoader=new B.FileLoader(this.options.manager);this.fileLoader.setResponseType("arraybuffer");if(this.options.crossOrigin==="use-credentials"){this.fileLoader.setWithCredentials(true)}}D.prototype.parse=function(a,e){var t=this;var n=this.json;var i=this.extensions;this.cache.removeAll();this.markDefs();Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(e){var r={scene:e[0][n.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:n.asset,parser:t,userData:{}};N(i,r,n);U(r,n);a(r)}).catch(e)};D.prototype.markDefs=function(){var e=this.json.nodes||[];var r=this.json.skins||[];var a=this.json.meshes||[];var t={};var n={};for(var i=0,s=r.length;i<s;i++){var o=r[i].joints;for(var u=0,l=o.length;u<l;u++){e[o[u]].isBone=true}}for(var f=0,p=e.length;f<p;f++){var c=e[f];if(c.mesh!==undefined){if(t[c.mesh]===undefined){t[c.mesh]=n[c.mesh]=0}t[c.mesh]++;if(c.skin!==undefined){a[c.mesh].isSkinnedMesh=true}}}this.json.meshReferences=t;this.json.meshUses=n};D.prototype.getDependency=function(e,r){var a=e+":"+r;var t=this.cache.get(a);if(!t){switch(e){case"scene":t=this.loadScene(r);break;case"node":t=this.loadNode(r);break;case"mesh":t=this.loadMesh(r);break;case"accessor":t=this.loadAccessor(r);break;case"bufferView":t=this.loadBufferView(r);break;case"buffer":t=this.loadBuffer(r);break;case"material":t=this.loadMaterial(r);break;case"texture":t=this.loadTexture(r);break;case"skin":t=this.loadSkin(r);break;case"animation":t=this.loadAnimation(r);break;case"camera":t=this.loadCamera(r);break;case"light":t=this.extensions[h.KHR_LIGHTS_PUNCTUAL].loadLight(r);break;default:throw new Error("Unknown type: "+e)}this.cache.add(a,t)}return t};D.prototype.getDependencies=function(a){var e=this.cache.get(a);if(!e){var t=this;var r=this.json[a+(a==="mesh"?"es":"s")]||[];e=Promise.all(r.map(function(e,r){return t.getDependency(a,r)}));this.cache.add(a,e)}return e};D.prototype.loadBuffer=function(e){var a=this.json.buffers[e];var t=this.fileLoader;if(a.type&&a.type!=="arraybuffer"){throw new Error("THREE.GLTFLoader: "+a.type+" buffer type is not supported.")}if(a.uri===undefined&&e===0){return Promise.resolve(this.extensions[h.KHR_BINARY_GLTF].body)}var n=this.options;return new Promise(function(e,r){t.load(F(a.uri,n.path),e,undefined,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+a.uri+'".'))})})};D.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){var r=t.byteLength||0;var a=t.byteOffset||0;return e.slice(a,a+r)})};D.prototype.loadAccessor=function(e){var R=this;var E=this.json;var A=this.json.accessors[e];if(A.bufferView===undefined&&A.sparse===undefined){return Promise.resolve(null)}var r=[];if(A.bufferView!==undefined){r.push(this.getDependency("bufferView",A.bufferView))}else{r.push(null)}if(A.sparse!==undefined){r.push(this.getDependency("bufferView",A.sparse.indices.bufferView));r.push(this.getDependency("bufferView",A.sparse.values.bufferView))}return Promise.all(r).then(function(e){var r=e[0];var a=x[A.type];var t=_[A.componentType];var n=t.BYTES_PER_ELEMENT;var i=n*a;var s=A.byteOffset||0;var o=A.bufferView!==undefined?E.bufferViews[A.bufferView].byteStride:undefined;var u=A.normalized===true;var l,f;if(o&&o!==i){var p=Math.floor(s/o);var c="InterleavedBuffer:"+A.bufferView+":"+A.componentType+":"+p+":"+A.count;var d=R.cache.get(c);if(!d){l=new t(r,p*o,A.count*o/n);d=new B.InterleavedBuffer(l,o/n);R.cache.add(c,d)}f=new B.InterleavedBufferAttribute(d,a,s%o/n,u)}else{if(r===null){l=new t(A.count*a)}else{l=new t(r,s,A.count*a)}f=new B.BufferAttribute(l,a,u)}if(A.sparse!==undefined){var h=x.SCALAR;var v=_[A.sparse.indices.componentType];var m=A.sparse.indices.byteOffset||0;var g=A.sparse.values.byteOffset||0;var T=new v(e[1],m,A.sparse.count*h);var M=new t(e[2],g,A.sparse.count*a);if(r!==null){f.setArray(f.array.slice())}for(var S=0,L=T.length;S<L;S++){var y=T[S];f.setX(y,M[S*a]);if(a>=2)f.setY(y,M[S*a+1]);if(a>=3)f.setZ(y,M[S*a+2]);if(a>=4)f.setW(y,M[S*a+3]);if(a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return f})};D.prototype.loadTexture=function(e){var r=this;var t=this.json;var n=this.options;var i=this.textureLoader;var s=window.URL||window.webkitURL;var o=t.textures[e];var u=o.extensions||{};var l;if(u[h.MSFT_TEXTURE_DDS]){l=t.images[u[h.MSFT_TEXTURE_DDS].source]}else{l=t.images[o.source]}var f=l.uri;var p=false;if(l.bufferView!==undefined){f=r.getDependency("bufferView",l.bufferView).then(function(e){p=true;var r=new Blob([e],{type:l.mimeType});f=s.createObjectURL(r);return f})}return Promise.resolve(f).then(function(a){var t=B.Loader.Handlers.get(a);if(!t){t=u[h.MSFT_TEXTURE_DDS]?r.extensions[h.MSFT_TEXTURE_DDS].ddsLoader:i}return new Promise(function(e,r){t.load(F(a,n.path),e,undefined,r)})}).then(function(e){if(p===true){s.revokeObjectURL(f)}e.flipY=false;if(o.name!==undefined)e.name=o.name;if(l.mimeType in P){e.format=P[l.mimeType]}var r=t.samplers||{};var a=r[o.sampler]||{};e.magFilter=y[a.magFilter]||B.LinearFilter;e.minFilter=y[a.minFilter]||B.LinearMipmapLinearFilter;e.wrapS=R[a.wrapS]||B.RepeatWrapping;e.wrapT=R[a.wrapT]||B.RepeatWrapping;return e})};D.prototype.assignTexture=function(a,t,n){var i=this;return this.getDependency("texture",n.index).then(function(e){if(!e.isCompressedTexture){switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":e.format=B.RGBFormat;break}}if(i.extensions[h.KHR_TEXTURE_TRANSFORM]){var r=n.extensions!==undefined?n.extensions[h.KHR_TEXTURE_TRANSFORM]:undefined;if(r){e=i.extensions[h.KHR_TEXTURE_TRANSFORM].extendTexture(e,r)}}a[t]=e})};D.prototype.assignFinalMaterial=function(e){var r=e.geometry;var a=e.material;var t=this.extensions;var n=r.attributes.tangent!==undefined;var i=r.attributes.color!==undefined;var s=r.attributes.normal===undefined;var o=e.isSkinnedMesh===true;var u=Object.keys(r.morphAttributes).length>0;var l=u&&r.morphAttributes.normal!==undefined;if(e.isPoints){var f="PointsMaterial:"+a.uuid;var p=this.cache.get(f);if(!p){p=new B.PointsMaterial;B.Material.prototype.copy.call(p,a);p.color.copy(a.color);p.map=a.map;p.lights=false;p.sizeAttenuation=false;this.cache.add(f,p)}a=p}else if(e.isLine){var f="LineBasicMaterial:"+a.uuid;var c=this.cache.get(f);if(!c){c=new B.LineBasicMaterial;B.Material.prototype.copy.call(c,a);c.color.copy(a.color);c.lights=false;this.cache.add(f,c)}a=c}if(n||i||s||o||u){var f="ClonedMaterial:"+a.uuid+":";if(a.isGLTFSpecularGlossinessMaterial)f+="specular-glossiness:";if(o)f+="skinning:";if(n)f+="vertex-tangents:";if(i)f+="vertex-colors:";if(s)f+="flat-shading:";if(u)f+="morph-targets:";if(l)f+="morph-normals:";var d=this.cache.get(f);if(!d){d=a.isGLTFSpecularGlossinessMaterial?t[h.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(a):a.clone();if(o)d.skinning=true;if(n)d.vertexTangents=true;if(i)d.vertexColors=B.VertexColors;if(s)d.flatShading=true;if(u)d.morphTargets=true;if(l)d.morphNormals=true;this.cache.add(f,d)}a=d}if(a.aoMap&&r.attributes.uv2===undefined&&r.attributes.uv!==undefined){console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap.");r.addAttribute("uv2",new B.BufferAttribute(r.attributes.uv.array,2))}if(a.isGLTFSpecularGlossinessMaterial){e.onBeforeRender=t[h.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms}e.material=a};D.prototype.loadMaterial=function(e){var r=this;var a=this.json;var t=this.extensions;var n=a.materials[e];var i;var s={};var o=n.extensions||{};var u=[];if(o[h.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var l=t[h.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];i=l.getMaterialType();u.push(l.extendParams(s,n,r))}else if(o[h.KHR_MATERIALS_UNLIT]){var f=t[h.KHR_MATERIALS_UNLIT];i=f.getMaterialType();u.push(f.extendParams(s,n,r))}else{i=B.MeshStandardMaterial;var p=n.pbrMetallicRoughness||{};s.color=new B.Color(1,1,1);s.opacity=1;if(Array.isArray(p.baseColorFactor)){var c=p.baseColorFactor;s.color.fromArray(c);s.opacity=c[3]}if(p.baseColorTexture!==undefined){u.push(r.assignTexture(s,"map",p.baseColorTexture))}s.metalness=p.metallicFactor!==undefined?p.metallicFactor:1;s.roughness=p.roughnessFactor!==undefined?p.roughnessFactor:1;if(p.metallicRoughnessTexture!==undefined){u.push(r.assignTexture(s,"metalnessMap",p.metallicRoughnessTexture));u.push(r.assignTexture(s,"roughnessMap",p.metallicRoughnessTexture))}}if(n.doubleSided===true){s.side=B.DoubleSide}var d=n.alphaMode||A.OPAQUE;if(d===A.BLEND){s.transparent=true}else{s.transparent=false;if(d===A.MASK){s.alphaTest=n.alphaCutoff!==undefined?n.alphaCutoff:.5}}if(n.normalTexture!==undefined&&i!==B.MeshBasicMaterial){u.push(r.assignTexture(s,"normalMap",n.normalTexture));s.normalScale=new B.Vector2(1,1);if(n.normalTexture.scale!==undefined){s.normalScale.set(n.normalTexture.scale,n.normalTexture.scale)}}if(n.occlusionTexture!==undefined&&i!==B.MeshBasicMaterial){u.push(r.assignTexture(s,"aoMap",n.occlusionTexture));if(n.occlusionTexture.strength!==undefined){s.aoMapIntensity=n.occlusionTexture.strength}}if(n.emissiveFactor!==undefined&&i!==B.MeshBasicMaterial){s.emissive=(new B.Color).fromArray(n.emissiveFactor)}if(n.emissiveTexture!==undefined&&i!==B.MeshBasicMaterial){u.push(r.assignTexture(s,"emissiveMap",n.emissiveTexture))}return Promise.all(u).then(function(){var e;if(i===B.ShaderMaterial){e=t[h.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(s)}else{e=new i(s)}if(n.name!==undefined)e.name=n.name;if(e.map)e.map.encoding=B.sRGBEncoding;if(e.emissiveMap)e.emissiveMap.encoding=B.sRGBEncoding;if(e.specularMap)e.specularMap.encoding=B.sRGBEncoding;U(e,n);if(n.extensions)N(t,e,n);return e})};function H(a,e,t){var r=e.attributes;var n=[];function i(e,r){return t.getDependency("accessor",e).then(function(e){a.addAttribute(r,e)})}for(var s in r){var o=E[s]||s.toLowerCase();if(o in a.attributes)continue;n.push(i(r[s],o))}if(e.indices!==undefined&&!a.index){var u=t.getDependency("accessor",e.indices).then(function(e){a.setIndex(e)});n.push(u)}U(a,e);return Promise.all(n).then(function(){return e.targets!==undefined?f(a,e.targets,t):a})}D.prototype.loadGeometries=function(e){var a=this;var t=this.extensions;var r=this.primitiveCache;function n(r){return t[h.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(r,a).then(function(e){return H(e,r,a)})}var i=[];for(var s=0,o=e.length;s<o;s++){var u=e[s];var l=G(u);var f=r[l];if(f){i.push(f.promise)}else{var p;if(u.extensions&&u.extensions[h.KHR_DRACO_MESH_COMPRESSION]){p=n(u)}else{p=H(new B.BufferGeometry,u,a)}r[l]={primitive:u,promise:p};i.push(p)}}return Promise.all(i)};D.prototype.loadMesh=function(f){var p=this;var e=this.json;var c=e.meshes[f];var d=c.primitives;var r=[];for(var a=0,t=d.length;a<t;a++){var n=d[a].material===undefined?i():this.getDependency("material",d[a].material);r.push(n)}return Promise.all(r).then(function(l){return p.loadGeometries(d).then(function(e){var r=[];for(var a=0,t=e.length;a<t;a++){var n=e[a];var i=d[a];var s;var o=l[a];if(i.mode===L.TRIANGLES||i.mode===L.TRIANGLE_STRIP||i.mode===L.TRIANGLE_FAN||i.mode===undefined){s=c.isSkinnedMesh===true?new B.SkinnedMesh(n,o):new B.Mesh(n,o);if(s.isSkinnedMesh===true&&!s.geometry.attributes.skinWeight.normalized){s.normalizeSkinWeights()}if(i.mode===L.TRIANGLE_STRIP){s.drawMode=B.TriangleStripDrawMode}else if(i.mode===L.TRIANGLE_FAN){s.drawMode=B.TriangleFanDrawMode}}else if(i.mode===L.LINES){s=new B.LineSegments(n,o)}else if(i.mode===L.LINE_STRIP){s=new B.Line(n,o)}else if(i.mode===L.LINE_LOOP){s=new B.LineLoop(n,o)}else if(i.mode===L.POINTS){s=new B.Points(n,o)}else{throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+i.mode)}if(Object.keys(s.geometry.morphAttributes).length>0){O(s,c)}s.name=c.name||"mesh_"+f;if(e.length>1)s.name+="_"+a;U(s,c);p.assignFinalMaterial(s);r.push(s)}if(r.length===1){return r[0]}var u=new B.Group;for(var a=0,t=r.length;a<t;a++){u.add(r[a])}return u})})};D.prototype.loadCamera=function(e){var r;var a=this.json.cameras[e];var t=a[a.type];if(!t){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}if(a.type==="perspective"){r=new B.PerspectiveCamera(B.Math.radToDeg(t.yfov),t.aspectRatio||1,t.znear||1,t.zfar||2e6)}else if(a.type==="orthographic"){r=new B.OrthographicCamera(t.xmag/-2,t.xmag/2,t.ymag/2,t.ymag/-2,t.znear,t.zfar)}if(a.name!==undefined)r.name=a.name;U(r,a);return Promise.resolve(r)};D.prototype.loadSkin=function(e){var r=this.json.skins[e];var a={joints:r.joints};if(r.inverseBindMatrices===undefined){return Promise.resolve(a)}return this.getDependency("accessor",r.inverseBindMatrices).then(function(e){a.inverseBindMatrices=e;return a})};D.prototype.loadAnimation=function(A){var e=this.json;var _=e.animations[A];var r=[];var a=[];var t=[];var n=[];var i=[];for(var s=0,o=_.channels.length;s<o;s++){var u=_.channels[s];var l=_.samplers[u.sampler];var f=u.target;var p=f.node!==undefined?f.node:f.id;var c=_.parameters!==undefined?_.parameters[l.input]:l.input;var d=_.parameters!==undefined?_.parameters[l.output]:l.output;r.push(this.getDependency("node",p));a.push(this.getDependency("accessor",c));t.push(this.getDependency("accessor",d));n.push(l);i.push(f)}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(t),Promise.all(n),Promise.all(i)]).then(function(e){var r=e[0];var a=e[1];var t=e[2];var n=e[3];var i=e[4];var s=[];for(var o=0,u=r.length;o<u;o++){var l=r[o];var f=a[o];var p=t[o];var c=n[o];var d=i[o];if(l===undefined)continue;l.updateMatrix();l.matrixAutoUpdate=true;var h;switch(b[d.path]){case b.weights:h=B.NumberKeyframeTrack;break;case b.rotation:h=B.QuaternionKeyframeTrack;break;case b.position:case b.scale:default:h=B.VectorKeyframeTrack;break}var v=l.name?l.name:l.uuid;var m=c.interpolation!==undefined?I[c.interpolation]:B.InterpolateLinear;var g=[];if(b[d.path]===b.weights){l.traverse(function(e){if(e.isMesh===true&&e.morphTargetInfluences){g.push(e.name?e.name:e.uuid)}})}else{g.push(v)}var T=p.array;if(p.normalized){var M;if(T.constructor===Int8Array){M=1/127}else if(T.constructor===Uint8Array){M=1/255}else if(T.constructor==Int16Array){M=1/32767}else if(T.constructor===Uint16Array){M=1/65535}else{throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.")}var S=new Float32Array(T.length);for(var L=0,y=T.length;L<y;L++){S[L]=T[L]*M}T=S}for(var L=0,y=g.length;L<y;L++){var R=new h(g[L]+"."+b[d.path],f.array,T,m);if(c.interpolation==="CUBICSPLINE"){R.createInterpolant=function e(r){return new w(this.times,this.values,this.getValueSize()/3,r)};R.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=true}s.push(R)}}var E=_.name!==undefined?_.name:"animation_"+A;return new B.AnimationClip(E,undefined,s)})};D.prototype.loadNode=function(e){var r=this.json;var i=this.extensions;var a=this;var s=r.meshReferences;var o=r.meshUses;var u=r.nodes[e];return function(){var e=[];if(u.mesh!==undefined){e.push(a.getDependency("mesh",u.mesh).then(function(e){var r;if(s[u.mesh]>1){var a=o[u.mesh]++;r=e.clone();r.name+="_instance_"+a;r.onBeforeRender=e.onBeforeRender;for(var t=0,n=r.children.length;t<n;t++){r.children[t].name+="_instance_"+a;r.children[t].onBeforeRender=e.children[t].onBeforeRender}}else{r=e}if(u.weights!==undefined){r.traverse(function(e){if(!e.isMesh)return;for(var r=0,a=u.weights.length;r<a;r++){e.morphTargetInfluences[r]=u.weights[r]}})}return r}))}if(u.camera!==undefined){e.push(a.getDependency("camera",u.camera))}if(u.extensions&&u.extensions[h.KHR_LIGHTS_PUNCTUAL]&&u.extensions[h.KHR_LIGHTS_PUNCTUAL].light!==undefined){e.push(a.getDependency("light",u.extensions[h.KHR_LIGHTS_PUNCTUAL].light))}return Promise.all(e)}().then(function(e){var r;if(u.isBone===true){r=new B.Bone}else if(e.length>1){r=new B.Group}else if(e.length===1){r=e[0]}else{r=new B.Object3D}if(r!==e[0]){for(var a=0,t=e.length;a<t;a++){r.add(e[a])}}if(u.name!==undefined){r.userData.name=u.name;r.name=B.PropertyBinding.sanitizeNodeName(u.name)}U(r,u);if(u.extensions)N(i,r,u);if(u.matrix!==undefined){var n=new B.Matrix4;n.fromArray(u.matrix);r.applyMatrix(n)}else{if(u.translation!==undefined){r.position.fromArray(u.translation)}if(u.rotation!==undefined){r.quaternion.fromArray(u.rotation)}if(u.scale!==undefined){r.scale.fromArray(u.scale)}}return r})};D.prototype.loadScene=function(){function p(e,s,o,l){var f=o.nodes[e];return l.getDependency("node",e).then(function(e){if(f.skin===undefined)return e;var u;return l.getDependency("skin",f.skin).then(function(e){u=e;var r=[];for(var a=0,t=u.joints.length;a<t;a++){r.push(l.getDependency("node",u.joints[a]))}return Promise.all(r)}).then(function(o){e.traverse(function(e){if(!e.isMesh)return;var r=[];var a=[];for(var t=0,n=o.length;t<n;t++){var i=o[t];if(i){r.push(i);var s=new B.Matrix4;if(u.inverseBindMatrices!==undefined){s.fromArray(u.inverseBindMatrices.array,t*16)}a.push(s)}else{console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',u.joints[t])}}e.bind(new B.Skeleton(r,a),e.matrixWorld)});return e})}).then(function(e){s.add(e);var r=[];if(f.children){var a=f.children;for(var t=0,n=a.length;t<n;t++){var i=a[t];r.push(p(i,e,o,l))}}return Promise.all(r)})}return function e(r){var a=this.json;var t=this.extensions;var n=this.json.scenes[r];var i=this;var s=new B.Scene;if(n.name!==undefined)s.name=n.name;U(s,n);if(n.extensions)N(t,s,n);var o=n.nodes||[];var u=[];for(var l=0,f=o.length;l<f;l++){u.push(p(o[l],s,a,i))}return Promise.all(u).then(function(){return s})}}();return e}()}