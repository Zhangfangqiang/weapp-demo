export default function(e){let{AnimationClip:g,AnimationMixer:M,Euler:w,Matrix4:k,Quaternion:t,QuaternionKeyframeTrack:y,SkeletonHelper:n,Vector2:B,Vector3:r,VectorKeyframeTrack:b}=e;var i={retarget:function(){var d=new r,c=new t,x=new r,h=new k,v=new k,g=new k;return function(e,t,n){n=n||{};n.preserveMatrix=n.preserveMatrix!==undefined?n.preserveMatrix:true;n.preservePosition=n.preservePosition!==undefined?n.preservePosition:true;n.preserveHipPosition=n.preserveHipPosition!==undefined?n.preserveHipPosition:false;n.useTargetMatrix=n.useTargetMatrix!==undefined?n.useTargetMatrix:false;n.hip=n.hip!==undefined?n.hip:"hip";n.names=n.names||{};var r=t.isObject3D?t.skeleton.bones:this.getBones(t),i=e.isObject3D?e.skeleton.bones:this.getBones(e),o,a,s,l,u,p;if(e.isObject3D){e.skeleton.pose()}else{n.useTargetMatrix=true;n.preserveMatrix=false}if(n.preservePosition){u=[];for(p=0;p<i.length;p++){u.push(i[p].position.clone())}}if(n.preserveMatrix){e.updateMatrixWorld();e.matrixWorld.identity();for(p=0;p<e.children.length;++p){e.children[p].updateMatrixWorld(true)}}if(n.offsets){o=[];for(p=0;p<i.length;++p){a=i[p];s=n.names[a.name]||a.name;if(n.offsets&&n.offsets[s]){a.matrix.multiply(n.offsets[s]);a.matrix.decompose(a.position,a.quaternion,a.scale);a.updateMatrixWorld()}o.push(a.matrixWorld.clone())}}for(p=0;p<i.length;++p){a=i[p];s=n.names[a.name]||a.name;l=this.getBoneByName(s,r);g.copy(a.matrixWorld);if(l){l.updateMatrixWorld();if(n.useTargetMatrix){v.copy(l.matrixWorld)}else{v.getInverse(e.matrixWorld);v.multiply(l.matrixWorld)}x.setFromMatrixScale(v);v.scale(x.set(1/x.x,1/x.y,1/x.z));g.makeRotationFromQuaternion(c.setFromRotationMatrix(v));if(e.isObject3D){var m=i.indexOf(a),f=o?o[m]:h.getInverse(e.skeleton.boneInverses[m]);g.multiply(f)}g.copyPosition(v)}if(a.parent&&a.parent.isBone){a.matrix.getInverse(a.parent.matrixWorld);a.matrix.multiply(g)}else{a.matrix.copy(g)}if(n.preserveHipPosition&&s===n.hip){a.matrix.setPosition(d.set(0,a.position.y,0))}a.matrix.decompose(a.position,a.quaternion,a.scale);a.updateMatrixWorld()}if(n.preservePosition){for(p=0;p<i.length;++p){a=i[p];s=n.names[a.name]||a.name;if(s!==n.hip){a.position.copy(u[p])}}}if(n.preserveMatrix){e.updateMatrixWorld(true)}}}(),retargetClip:function(e,t,n,r){r=r||{};r.useFirstFramePosition=r.useFirstFramePosition!==undefined?r.useFirstFramePosition:false;r.fps=r.fps!==undefined?r.fps:30;r.names=r.names||[];if(!t.isObject3D){t=this.getHelperFromSkeleton(t)}var i=Math.round(n.duration*(r.fps/1e3)*1e3),o=1/r.fps,a=[],s=new M(t),l=this.getBones(e.skeleton),u=[],p,m,f,d,c,x,h;s.clipAction(n).play();s.update(0);t.updateMatrixWorld();for(x=0;x<i;++x){var v=x*o;this.retarget(e,t,r);for(h=0;h<l.length;++h){c=r.names[l[h].name]||l[h].name;f=this.getBoneByName(c,t.skeleton);if(f){m=l[h];d=u[h]=u[h]||{bone:m};if(r.hip===c){if(!d.pos){d.pos={times:new Float32Array(i),values:new Float32Array(i*3)}}if(r.useFirstFramePosition){if(x===0){p=m.position.clone()}m.position.sub(p)}d.pos.times[x]=v;m.position.toArray(d.pos.values,x*3)}if(!d.quat){d.quat={times:new Float32Array(i),values:new Float32Array(i*4)}}d.quat.times[x]=v;m.quaternion.toArray(d.quat.values,x*4)}}s.update(o);t.updateMatrixWorld()}for(x=0;x<u.length;++x){d=u[x];if(d){if(d.pos){a.push(new b(".bones["+d.bone.name+"].position",d.pos.times,d.pos.values))}a.push(new y(".bones["+d.bone.name+"].quaternion",d.quat.times,d.quat.values))}}s.uncacheAction(n);return new g(n.name,-1,a)},getHelperFromSkeleton:function(e){var t=new n(e.bones[0]);t.skeleton=e;return t},getSkeletonOffsets:function(){var h=new r,v=new r,g=new r,M=new r,y=new B,b=new B;return function(e,t,n){n=n||{};n.hip=n.hip!==undefined?n.hip:"hip";n.names=n.names||{};if(!t.isObject3D){t=this.getHelperFromSkeleton(t)}var r=Object.keys(n.names),i=Object.values(n.names),o=t.isObject3D?t.skeleton.bones:this.getBones(t),a=e.isObject3D?e.skeleton.bones:this.getBones(e),s=[],l,u,p,m;e.skeleton.pose();for(m=0;m<a.length;++m){l=a[m];p=n.names[l.name]||l.name;u=this.getBoneByName(p,o);if(u&&p!==n.hip){var f=this.getNearestBone(l.parent,r),d=this.getNearestBone(u.parent,i);f.updateMatrixWorld();d.updateMatrixWorld();h.setFromMatrixPosition(f.matrixWorld);v.setFromMatrixPosition(l.matrixWorld);g.setFromMatrixPosition(d.matrixWorld);M.setFromMatrixPosition(u.matrixWorld);y.subVectors(new B(v.x,v.y),new B(h.x,h.y)).normalize();b.subVectors(new B(M.x,M.y),new B(g.x,g.y)).normalize();var c=y.angle()-b.angle();var x=(new k).makeRotationFromEuler(new w(0,0,c));l.matrix.multiply(x);l.matrix.decompose(l.position,l.quaternion,l.scale);l.updateMatrixWorld();s[p]=x}}return s}}(),renameBones:function(e,t){var n=this.getBones(e);for(var r=0;r<n.length;++r){var i=n[r];if(t[i.name]){i.name=t[i.name]}}return this},getBones:function(e){return Array.isArray(e)?e:e.bones},getBoneByName:function(e,t){for(var n=0,r=this.getBones(t);n<r.length;n++){if(e===r[n].name)return r[n]}},getNearestBone:function(e,t){while(e.isBone){if(t.indexOf(e.name)!==-1){return e}e=e.parent}},findBoneTrackData:function(e,t){var n=/\[(.*)\]\.(.*)/,r={name:e};for(var i=0;i<t.length;++i){var o=n.exec(t[i].name);if(o&&e===o[1]){r[o[2]]=i}}return r},getEqualsBonesNames:function(e,t){var n=this.getBones(e),r=this.getBones(t),i=[];e:for(var o=0;o<n.length;o++){var a=n[o].name;for(var s=0;s<r.length;s++){if(a===r[s].name){i.push(a);continue e}}}return i},clone:function(e){var i=new Map;var o=new Map;var t=e.clone();a(e,t,function(e,t){i.set(t,e);o.set(e,t)});t.traverse(function(e){if(!e.isSkinnedMesh)return;var t=e;var n=i.get(e);var r=n.skeleton.bones;t.skeleton=n.skeleton.clone();t.bindMatrix.copy(n.bindMatrix);t.skeleton.bones=r.map(function(e){return o.get(e)});t.bind(t.skeleton,t.bindMatrix)});return t}};function a(e,t,n){n(e,t);for(var r=0;r<e.children.length;r++){a(e.children[r],t.children[r],n)}}return{SkeletonUtils:i}}